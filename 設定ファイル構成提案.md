# 設定ファイル構成提案

## ディレクトリ構成

```
trail_status/services/
├── prompts/
│   ├── base.yaml           # 共通プロンプト定義
│   ├── okutama_vc.yaml     # 奥多摩ビジターセンター用
│   ├── env_ministry.yaml   # 環境省用
│   └── tokyo_gov.yaml      # 東京都用
├── config/
│   └── ai_models.yaml      # AI設定（モデル、パラメータ）
└── sample/
    ├── sample_okutama_vc.txt
    └── sample_env_ministry.txt
```

## 1. プロンプト設定（prompts/）

### base.yaml
```yaml
# 共通プロンプト設定
base_instructions: |
  あなたは登山道危険情報の分析AIです。
  公的機関の発表を正確に構造化してください。

common_rules:
  - 原文は必ず保持
  - 危険レベルを正確に判定
  - 日付情報を抽出

schema_instruction: |
  以下のPydanticスキーマに従ってJSONで出力してください
```

### サイト別yaml例（okutama_vc.yaml）
```yaml
# base.yamlを継承
extends: base.yaml

site_specific:
  name: "奥多摩ビジターセンター"
  base_url: "https://www.ces-net.jp/okutamavc/"
  
prompt: |
  {{ base_instructions }}
  
  【特別指示】
  - 奥多摩エリアの情報に特化
  - ビジターセンターの公式発表として扱う
  - 山域は主に「OKUTAMA」を使用
  
  {{ common_rules }}
  {{ schema_instruction }}
```

### サイト別yaml例（env_ministry.yaml）
```yaml
extends: base.yaml

site_specific:
  name: "環境省"
  base_url: "https://www.env.go.jp/park/"
  
prompt: |
  {{ base_instructions }}
  
  【特別指示】
  - 国立公園の公式発表として扱う
  - 広域エリアの情報が含まれる可能性
  - 法的根拠のある情報として高い信頼度
  
  {{ common_rules }}
  {{ schema_instruction }}
```

### サイト別yaml例（tokyo_gov.yaml）
```yaml
extends: base.yaml

site_specific:
  name: "東京都"
  base_url: "https://www.metro.tokyo.lg.jp/"
  
prompt: |
  {{ base_instructions }}
  
  【特別指示】
  - 東京都内の山域に特化
  - 都の防災情報との関連を考慮
  - 主に「OKUTAMA」「OKUTAMA_WEST」エリア
  
  {{ common_rules }}
  {{ schema_instruction }}
```

## 2. AI設定（config/）

### ai_models.yaml
```yaml
# AIモデル設定
models:
  deepseek:
    default_model: "deepseek-reasoner"
    temperature: 0.3
    max_tokens: 4000
    api_base_url: "https://api.deepseek.com"
    timeout: 120
    
  gemini:
    default_model: "gemini-3-flash-preview"
    temperature: 0.3
    thinking_budget: 2000
    timeout: 120

# フォールバック設定
fallback:
  primary: "deepseek"
  secondary: "gemini"
  retry_count: 3
  retry_delay: 5  # seconds

# 実行設定
execution:
  parallel_requests: 3
  rate_limit:
    deepseek: 10  # requests per minute
    gemini: 20    # requests per minute
    
# 出力設定
output:
  save_raw_response: true  # DEBUGモードでのみ
  response_format: "json_object"
  validation_strict: true

# ログ設定
logging:
  level: "INFO"
  include_token_stats: true
  include_timing: true
```

## 3. 設定読み込み方法

### プロンプト設定の読み込み
```python
def load_prompt_config(site_name: str) -> dict:
    """サイト別プロンプト設定を読み込み（base.yamlを継承）"""
    base_path = settings.BASE_DIR / "trail_status" / "services" / "prompts"
    
    # base.yamlを読み込み
    base_config = yaml.safe_load((base_path / "base.yaml").read_text(encoding="utf-8"))
    
    # サイト別設定を読み込み
    site_config = yaml.safe_load((base_path / f"{site_name}.yaml").read_text(encoding="utf-8"))
    
    # 設定をマージ（テンプレート展開含む）
    return merge_configs(base_config, site_config)
```

### AI設定の読み込み
```python
def load_ai_config() -> dict:
    """AI設定を読み込み"""
    config_path = settings.BASE_DIR / "trail_status" / "services" / "config" / "ai_models.yaml"
    return yaml.safe_load(config_path.read_text(encoding="utf-8"))
```

## 4. 実装時の考慮事項

### 設定の継承
- `base.yaml`の共通設定をサイト別で上書き可能
- テンプレート変数（`{{ base_instructions }}`）の展開
- 設定の深いマージ（辞書の再帰的結合）

### 設定の検証
- 必須フィールドの存在確認
- モデル名、パラメータの有効性検証
- プロンプトテンプレートの構文チェック

### 設定の切り替え
- 環境変数での設定オーバーライド
- デバッグモードでの設定変更
- ホットリロード対応（開発時）

### エラーハンドリング
- 設定ファイル不正時のデフォルト値
- ネットワークエラー時のフォールバック
- APIキー未設定時の適切なエラーメッセージ

## 5. 将来拡張での考慮事項

### config/に追加される可能性
- `scraping_config.yaml` - スクレイピング設定
- `validation_rules.yaml` - データ検証ルール
- `processing_config.yaml` - バッチ処理設定
- `notification_config.yaml` - 通知設定

### prompts/の拡張
- `templates/` サブディレクトリ
- 多言語対応（`ja/`, `en/`）
- バージョン管理（`v1/`, `v2/`）

## 注意事項

- **data_sources設定は不要**: DBのDataSourceモデルで管理済み
- **設定変更時の影響**: アプリケーション再起動が必要
- **セキュリティ**: APIキーは環境変数で管理、設定ファイルには含めない